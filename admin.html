<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BERA TECH | Admin Dashboard</title>
    <style>
        /* Admin Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            color: #333;
        }
        
        /* Admin Navigation */
        .admin-nav {
            background: #2c3e50;
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
        }
        
        .nav-user {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
        }
        
        .nav-user button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .nav-user button:hover {
            background: #c0392b;
        }
        
        /* Admin Container */
        .admin-container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        /* Dashboard Header */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .dashboard-title {
            font-size: 2rem;
            color: #2c3e50;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            color: #7f8c8d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #27ae60;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        /* Tables */
        .table-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .table-header h2 {
            color: #2c3e50;
            font-size: 1.3rem;
        }
        
        .table-actions {
            display: flex;
            gap: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
            text-align: left;
            padding: 15px;
            border-bottom: 2px solid #e1e5e9;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #e1e5e9;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Forms */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #2c3e50;
            color: white;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-title {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            color: #7f8c8d;
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification.success {
            background: #27ae60;
        }
        
        .notification.error {
            background: #e74c3c;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .admin-container {
                padding: 0 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .table-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .table-actions {
                justify-content: center;
            }
            
            table {
                font-size: 0.9rem;
            }
            
            th, td {
                padding: 10px;
            }
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div id="loginPage" class="login-container" style="display: none;">
        <div class="login-card">
            <div class="login-header">
                <h1 class="login-title">üõ°Ô∏è BERA TECH</h1>
                <p class="login-subtitle">Admin Dashboard Login</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary btn-block" style="width: 100%;">
                    üîê Sign In
                </button>
            </form>
        </div>
    </div>

    <div id="dashboardPage" style="display: none;">
        <!-- Navigation -->
        <nav class="admin-nav">
            <div class="nav-container">
                <div class="nav-brand">
                    üõ°Ô∏è BERA TECH Admin
                </div>
                <div class="nav-user">
                    <span id="userName">Admin</span>
                    <button onclick="logout()">üö™ Logout</button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="admin-container">
            <div class="dashboard-header">
                <h1 class="dashboard-title">üìä Dashboard Overview</h1>
                <button class="btn btn-primary" onclick="refreshDashboard()">
                    üîÑ Refresh
                </button>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Transactions</h3>
                    <div class="stat-value" id="totalTransactions">0</div>
                    <div class="stat-label">All Time</div>
                </div>
                <div class="stat-card">
                    <h3>Successful</h3>
                    <div class="stat-value" id="successfulTransactions">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <h3>Pending</h3>
                    <div class="stat-value" id="pendingTransactions">0</div>
                    <div class="stat-label">Awaiting Completion</div>
                </div>
                <div class="stat-card">
                    <h3>Success Rate</h3>
                    <div class="stat-value" id="successRate">0%</div>
                    <div class="stat-label">Overall</div>
                </div>
                <div class="stat-card">
                    <h3>Total Volume</h3>
                    <div class="stat-value" id="totalVolume">KES 0</div>
                    <div class="stat-label">Processed Amount</div>
                </div>
                <div class="stat-card">
                    <h3>Wallet Balance</h3>
                    <div class="stat-value" id="walletBalance">KES 0</div>
                    <div class="stat-label">Available Funds</div>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="table-container">
                <div class="table-header">
                    <h2>üìã Recent Transactions</h2>
                    <div class="table-actions">
                        <input type="text" id="searchInput" placeholder="Search..." style="padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd;">
                        <select id="statusFilter" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd;">
                            <option value="">All Status</option>
                            <option value="Completed">Completed</option>
                            <option value="Pending">Pending</option>
                            <option value="Failed">Failed</option>
                        </select>
                        <select id="typeFilter" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd;">
                            <option value="">All Types</option>
                            <option value="C2B">C2B</option>
                            <option value="B2C">B2C</option>
                            <option value="B2B">B2B</option>
                        </select>
                    </div>
                </div>
                <table id="transactionsTable">
                    <thead>
                        <tr>
                            <th>Reference</th>
                            <th>Type</th>
                            <th>Phone</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsBody">
                        <!-- Transactions will be loaded here -->
                    </tbody>
                </table>
                <div id="pagination" style="margin-top: 20px; text-align: center;"></div>
            </div>

            <!-- Initiate Payment -->
            <div class="table-container">
                <div class="table-header">
                    <h2>üöÄ Initiate Payment</h2>
                </div>
                <form id="adminPaymentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Payment Type</label>
                            <select id="adminPaymentType" required>
                                <option value="C2B">Customer to Business (C2B)</option>
                                <option value="B2C">Business to Customer (B2C)</option>
                                <option value="B2B">Business to Business (B2B)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="adminPhone" placeholder="254712345678" required>
                        </div>
                        <div class="form-group">
                            <label>Amount (KES)</label>
                            <input type="number" id="adminAmount" placeholder="100" min="1" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Customer Name</label>
                            <input type="text" id="adminCustomerName" placeholder="John Doe">
                        </div>
                        <div class="form-group">
                            <label>Reference</label>
                            <input type="text" id="adminReference" placeholder="ORDER-001">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        üöÄ Initiate Payment
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let authToken = localStorage.getItem('beraTechToken');
        let currentPage = 1;

        // Check authentication on load
        window.addEventListener('DOMContentLoaded', () => {
            if (!authToken) {
                showLoginPage();
            } else {
                showDashboardPage();
                loadDashboardData();
                loadTransactions();
            }
        });

        // Show login page
        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('dashboardPage').style.display = 'none';
            
            const loginForm = document.getElementById('loginForm');
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const submitBtn = e.target.querySelector('button');
                const originalText = submitBtn.innerHTML;
                
                try {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = 'Authenticating...';
                    
                    const response = await fetch(`${API_BASE}/admin/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        authToken = result.token;
                        localStorage.setItem('beraTechToken', authToken);
                        localStorage.setItem('beraTechUser', JSON.stringify(result.user));
                        
                        showNotification('success', 'Login successful!');
                        setTimeout(() => {
                            showDashboardPage();
                            loadDashboardData();
                            loadTransactions();
                        }, 1000);
                    } else {
                        showNotification('error', result.error);
                    }
                } catch (error) {
                    showNotification('error', 'Login failed. Please try again.');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            });
        }

        // Show dashboard page
        function showDashboardPage() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboardPage').style.display = 'block';
            
            // Set up admin payment form
            document.getElementById('adminPaymentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const payload = {
                    phone_number: document.getElementById('adminPhone').value,
                    amount: document.getElementById('adminAmount').value,
                    payment_type: document.getElementById('adminPaymentType').value,
                    external_reference: document.getElementById('adminReference').value || '',
                    customer_name: document.getElementById('adminCustomerName').value || ''
                };
                
                const submitBtn = e.target.querySelector('button');
                const originalText = submitBtn.innerHTML;
                
                try {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = 'Processing...';
                    
                    const response = await fetch(`${API_BASE}/stk-push`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showNotification('success', 'Payment initiated successfully!');
                        e.target.reset();
                        loadDashboardData();
                        loadTransactions();
                    } else {
                        showNotification('error', result.error);
                    }
                } catch (error) {
                    showNotification('error', 'Failed to initiate payment');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            });
            
            // Set up filters
            document.getElementById('searchInput').addEventListener('input', loadTransactions);
            document.getElementById('statusFilter').addEventListener('change', loadTransactions);
            document.getElementById('typeFilter').addEventListener('change', loadTransactions);
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                const response = await fetch(`${API_BASE}/admin/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const metrics = result.data.metrics;
                    document.getElementById('totalTransactions').textContent = metrics.totalTransactions;
                    document.getElementById('successfulTransactions').textContent = metrics.successfulTransactions;
                    document.getElementById('pendingTransactions').textContent = metrics.pendingTransactions;
                    document.getElementById('successRate').textContent = `${metrics.successRate}%`;
                    document.getElementById('totalVolume').textContent = `KES ${metrics.totalVolume}`;
                    document.getElementById('walletBalance').textContent = `KES ${result.data.walletBalance || '0.00'}`;
                }
            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }

        // Load transactions
        async function loadTransactions(page = 1) {
            currentPage = page;
            
            const search = document.getElementById('searchInput').value;
            const status = document.getElementById('statusFilter').value;
            const type = document.getElementById('typeFilter').value;
            
            let url = `${API_BASE}/transactions?page=${page}&limit=10`;
            if (search) url += `&phone=${search}`;
            if (status) url += `&status=${status}`;
            if (type) url += `&payment_type=${type}`;
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    renderTransactions(result.data.transactions);
                    renderPagination(result.data.pagination);
                }
            } catch (error) {
                console.error('Failed to load transactions:', error);
            }
        }

        // Render transactions table
        function renderTransactions(transactions) {
            const tbody = document.getElementById('transactionsBody');
            tbody.innerHTML = '';
            
            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${transaction.reference}</td>
                    <td>${transaction.payment_type}</td>
                    <td>${formatPhone(transaction.phone_number)}</td>
                    <td>KES ${transaction.amount}</td>
                    <td>
                        <span class="status-badge status-${transaction.status.toLowerCase()}">
                            ${transaction.status}
                        </span>
                    </td>
                    <td>${formatDate(transaction.initiated_at)}</td>
                    <td>
                        <button onclick="checkTransaction('${transaction.reference}')" class="btn" style="padding: 6px 12px; font-size: 12px;">
                            üîç Check
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Render pagination
        function renderPagination(pagination) {
            const container = document.getElementById('pagination');
            container.innerHTML = '';
            
            if (pagination.hasPrevPage) {
                const prevBtn = document.createElement('button');
                prevBtn.className = 'btn btn-secondary';
                prevBtn.textContent = '‚Üê Previous';
                prevBtn.onclick = () => loadTransactions(pagination.currentPage - 1);
                container.appendChild(prevBtn);
            }
            
            const infoSpan = document.createElement('span');
            infoSpan.style.margin = '0 15px';
            infoSpan.textContent = `Page ${pagination.currentPage} of ${pagination.totalPages}`;
            container.appendChild(infoSpan);
            
            if (pagination.hasNextPage) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'btn btn-secondary';
                nextBtn.textContent = 'Next ‚Üí';
                nextBtn.onclick = () => loadTransactions(pagination.currentPage + 1);
                container.appendChild(nextBtn);
            }
        }

        // Check transaction status
        async function checkTransaction(reference) {
            try {
                const response = await fetch(`${API_BASE}/transaction-status/${reference}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('success', `Status: ${result.data.status}`);
                    loadTransactions(currentPage);
                } else {
                    showNotification('error', result.error);
                }
            } catch (error) {
                showNotification('error', 'Failed to check status');
            }
        }

        // Refresh dashboard
        function refreshDashboard() {
            loadDashboardData();
            loadTransactions();
            showNotification('info', 'Dashboard refreshed');
        }

        // Logout
        function logout() {
            localStorage.removeItem('beraTechToken');
            localStorage.removeItem('beraTechUser');
            showLoginPage();
        }

        // Utility functions
        function formatPhone(phone) {
            return phone ? `+${phone}` : 'N/A';
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleString();
        }

        function showNotification(type, message) {
            // Remove existing notifications
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
    </script>
</body>
</html>
